language: node_js
node_js:
  - "8"
cache:
  directories:
    - node_modules
notifications:
  email:
    on_success: change
    on_failure: always
env:
  global:
    - PATH=$HOME/.local/bin:$PATH
stages:
  - unit tests
  - name: deploy to staging
    if: branch = master
  - name: test staging
    if: branch = master
  - name: deploy to production
    if: branch = master
  - name: test production
    if: branch = master
jobs:
  include:
    - stage: unit tests
      before_script: npm run build
      script: npm test
    - stage: deploy to staging
      before_script: npm run build
      script: skip
      before_deploy: pip install --user awscli
      deploy:
        - provider: script
          script: npm run deploy:staging
          skip_cleanup: true
          on:
            branch: master
    - stage: test staging
      script: npm run test:staging
    - stage: deploy to production
      script: skip
      before_deploy: pip install --user awscli
      deploy:
        - provider: script
          script: npm run promote
          skip_cleanup: true
          on:
            branch: master
    - stage: test production
      script: npm run test:production
